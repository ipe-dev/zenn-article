---
title: "【MySQL】実行計画のtypeについて調べてみた"
emoji: "😊"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [DB, MySQL]
published: false
---
## はじめに
MySQLの実行計画について勉強していた時、項目が多すぎて何を見たらいいのかわからなくなりました。
今回はパフォーマンスに直接関連する**type**という項目に絞り、出力される内容についてまとめたいと思います。
## そもそも実行計画とは？
DBMSがユーザーからクエリを受け取ると以下のように処理を行います。

1. クエリを解析する。
2. テーブルの統計情報を元に複数のデータの取得方法を立案する。
3. 最も推定コストの低いデータの取得方法を選択する。

このとき選択されたデータの取得方法が実行計画と呼ばれます。
MySQLにおいては、`EXPLAIN`というコマンドを使うことでクエリの実行計画を出力することができます。
例
```sql
explain select * from actor;
```
↓出力結果
```
+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------+
| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra |
+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------+
|  1 | SIMPLE      | actor | NULL       | ALL  | NULL          | NULL | NULL    | NULL |   10 |   100.00 | NULL  |
+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------+
```
各項目の細かい内容については[公式ドキュメント](https://dev.mysql.com/doc/refman/8.0/ja/explain-output.html)を参照ください。
## typeは検索方法を示す項目
typeはテーブルへのアクセス方法を示す項目です。
この項目を見ることでテーブルにアクセスする際のインデックスの使用方法や絞り込みの方法等を知ることができます。
### const
constはプライマリーキーやユニークキーを使った1行検索を行なった場合に表示されます。
以下の例ではactorテーブルに対してプライマリーキーで検索を行っているためconstが表示されています。
constが表示されている場合は高速な検索ができています。
```sql
explain select * from actor where actor_id = 1;
```
```
+----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+
| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref   | rows | filtered | Extra |
+----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+
|  1 | SIMPLE      | actor | NULL       | const | PRIMARY       | PRIMARY | 2       | const |    1 |   100.00 | NULL  |
+----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------+
```
### ref
1件に絞ることができたconstに対して、refはインデックスを使って複数行を検索した場合に表示されます。
以下の例ではaddressテーブルに対してcity_idで検索をかけています。
出力された実行計画のkeyの項目にidx_fk_city_idとありますが、これはidx_fk_city_idというインデックスを使って検索をしていることを示しています。
つまりcity_idにインデックスが貼られていますが、city_id=300のレコードが複数あるためrefとなっています。
refが表示されている場合も高速な検索ができています。
```sql
explain select * from address where city_id = 300;
```
```
+----+-------------+---------+------------+------+----------------+----------------+---------+-------+------+----------+-------+
| id | select_type | table   | partitions | type | possible_keys  | key            | key_len | ref   | rows | filtered | Extra |
+----+-------------+---------+------------+------+----------------+----------------+---------+-------+------+----------+-------+
|  1 | SIMPLE      | address | NULL       | ref  | idx_fk_city_id | idx_fk_city_id | 2       | const |    2 |   100.00 | NULL  |
+----+-------------+---------+------------+------+----------------+----------------+---------+-------+------+----------+-------+
```
### eq_ref
eq_refはテーブル結合でにユニークキーやプライマリーキーを使った時に表示されます。
先ほどの例ではactorテーブルのtypeがeq_refとなっています。
これはfilm_actorテーブルとactorテーブルを結合する際にプライマリーキーであるactor_idを使用しているので、1件のみの取得となりeq_refが表示されています。
eq_refの場合も高速な検索ができています。
### range
rangeはインデックスを使って範囲検索（BETWEEN,IN,<,>など）を行った際に表示されます。
例
```sql
explain select first_name from actor where actor_id in (1,2,3,4,5);
```
```
+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref  | rows | filtered | Extra       |
+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
|  1 | SIMPLE      | actor | NULL       | range | PRIMARY       | PRIMARY | 2       | NULL |    5 |   100.00 | Using where |
+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
```
### index
### ALL
## まとめ